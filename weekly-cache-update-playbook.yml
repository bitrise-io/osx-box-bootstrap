---
#
# Ansible playbook to prepare a Bitrise OS X VM/box, used through vagrant
#

- hosts: all
  # accelerate: true
  remote_user: vagrant
  become_method: sudo
  any_errors_fatal: True
  vars:
    - ansible_sudo_pass: vagrant
    - param_user: vagrant
  tasks:

    # ----------------------------------------
    # --- Setup profiles ---
    # ----------------------------------------

    # Make sure that the latest .bashrc is in place (which
    # references / loads the other profiles)
    - name: setup .bashrc
      copy: src=profiles/bashrc
        dest="/Users/{{ param_user }}/.bashrc"
        owner="{{ param_user }}"
        mode=0600
        
    - name: setup tools_profile
      copy: src=profiles/tools_profile
        dest="/Users/{{ param_user }}/.profiles/tools_profile"
        owner="{{ param_user }}"
        mode=0600

    # ----------------------------------------
    # --- pre-installed tool cache updates ---
    # ----------------------------------------

    - name: "brew update"
      shell: bash -l -c "brew update || brew update"

    - name: "CocoaPods: pod setup"
      shell: bash -l -c "pod setup || pod setup"


    # ----------------------------------------
    # --- Bitrise CLI tools ---
    # ----------------------------------------
    # bitrise CLI: cleanup previous tool versions
    - file: path=/usr/local/bin/bitrise state=absent
    - file: path=/usr/local/bin/stepman state=absent
    - file: path=/usr/local/bin/envman state=absent
    #
    - name: "bitrise CLI: download"
      shell: bash -l -c "curl -fL https://github.com/bitrise-io/bitrise/releases/download/1.4.5/bitrise-$(uname -s)-$(uname -m) > /usr/local/bin/bitrise"
    - name: "Make the bitrise CLI executable"
      file: path=/usr/local/bin/bitrise mode="u=rwx,g=rx,o=rx"
    - name: "Bitrise CLI test -version"
      shell: bash -l -c "bitrise --version"
    - name: "Bitrise CLI - setup"
      shell: bash -l -c "bitrise setup"
    - name: "Bitrise CLI - envman -version"
      shell: bash -l -c "/Users/vagrant/.bitrise/tools/envman -version"
    - name: "Bitrise CLI - stepman -version"
      shell: bash -l -c "/Users/vagrant/.bitrise/tools/stepman -version"
    # setup the default StepLib collection to stepman, for a pre-warmed
    #  cache for the StepLib
    - name: "stepman: init"
      shell: bash -l -c "/Users/vagrant/.bitrise/tools/stepman setup -c https://github.com/bitrise-io/bitrise-steplib.git"
    - name: "stepman: update"
      shell: bash -l -c "/Users/vagrant/.bitrise/tools/stepman update"


    - name: "bitrise-bridge: download"
      shell: bash -l -c "curl -fL https://github.com/bitrise-tools/bitrise-bridge/releases/download/0.9.11/bitrise-bridge-$(uname -s)-$(uname -m) > /usr/local/bin/bitrise-bridge"
    - name: "Make the bitrise-bridge executable"
      file: path=/usr/local/bin/bitrise-bridge mode="u=rwx,g=rx,o=rx"
    - name: "bitrise-bridge -version"
      shell: bash -l -c "bitrise-bridge --version"

    - name: "cmd-bridge: download"
      shell: bash -l -c "curl -fL https://github.com/bitrise-io/cmd-bridge/releases/download/0.9.5/cmd-bridge-$(uname -s)-$(uname -m) > /usr/local/bin/cmd-bridge"
    - name: "Make the cmd-bridge executable"
      file: path=/usr/local/bin/cmd-bridge mode="u=rwx,g=rx,o=rx"
    - name: "cmd-bridge -version"
      shell: bash -l -c "cmd-bridge --version"


    # ----------------------------------------
    # --- Cleanup ---
    # ----------------------------------------

    # Remove tmp / test dirs inside the HOME directory
    #  * DerivedData : remove the DerivedData content generated by the Bitrise Stack tester sample apps (built during Stack prepare, to validate the Xcode setup)
    - file: path="/Users/{{ param_user }}/{{ item.fold_path }}"
        state=absent
      with_items:
        - { fold_path: 'Library/Developer/Xcode/DerivedData' }
